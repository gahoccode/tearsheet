{% extends "base.html" %}

{% block title %}Portfolio Results - Tearsheet{% endblock %}

{% block container_class %}container-fluid px-3{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Portfolio Summary Card -->
        <div class="card shadow-lg border-0 mb-4">
            <div class="card-header bg-success text-white">
                <div class="row align-items-center">
                    <div class="col">
                        <h2 class="card-title mb-0">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            Analysis Complete
                        </h2>
                        <p class="card-subtitle mb-0 opacity-75">Your portfolio analysis is ready</p>
                    </div>
                    <div class="col-auto">
                        <a href="/" class="btn btn-light btn-sm">
                            <i class="bi bi-arrow-left me-2"></i>
                            New Analysis
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-muted">Portfolio Composition</h6>
                        {% for i in range(symbols|length) %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge bg-primary">{{ symbols[i] }}</span>
                            <span class="fw-semibold">{{ "%.1f"|format(weights[i] * 100) }}%</span>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted">Analysis Parameters</h6>
                        <div class="row g-2">
                            <div class="col-sm-6">
                                <small class="text-muted">Period</small>
                                <div class="fw-semibold">{{ start_date }} to {{ end_date }}</div>
                            </div>
                            <div class="col-sm-6">
                                <small class="text-muted">Initial Capital</small>
                                <div class="fw-semibold">â‚«{{ "{:,.0f}".format(capital) }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Charts Grid -->
        <div class="row g-4 mb-4">
            {% if summary_img %}
            <div class="col-lg-4">
                <div class="card h-100 shadow border-0">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-graph-up me-2"></i>
                            Performance Summary
                        </h6>
                    </div>
                    <div class="card-body p-3">
                        <img src="data:image/png;base64,{{ summary_img }}" alt="Portfolio Summary" class="img-fluid rounded">
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if monthly_img %}
            <div class="col-lg-4">
                <div class="card h-100 shadow border-0">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-calendar3 me-2"></i>
                            Monthly Returns
                        </h6>
                    </div>
                    <div class="card-body p-3">
                        <img src="data:image/png;base64,{{ monthly_img }}" alt="Monthly Heatmap" class="img-fluid rounded">
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if drawdown_img %}
            <div class="col-lg-4">
                <div class="card h-100 shadow border-0">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0">
                            <i class="bi bi-graph-down me-2"></i>
                            Drawdown Analysis
                        </h6>
                    </div>
                    <div class="card-body p-3">
                        <img src="data:image/png;base64,{{ drawdown_img }}" alt="Drawdown" class="img-fluid rounded">
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Full QuantStats Report -->
        <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-dark text-white rounded">
                <h4 class="mb-0">
                    <i class="bi bi-file-earmark-bar-graph me-2"></i>
                    Complete QuantStats Report
                </h4>
                <div class="btn-group" role="group">
                    <a href="{{ url_for('static', filename='reports/quantstats-results.html') }}" 
                       target="_blank" class="btn btn-outline-light btn-sm">
                        <i class="bi bi-box-arrow-up-right me-1"></i>
                        Open in New Tab
                    </a>
                    <a href="{{ url_for('static', filename='reports/quantstats-results.html') }}" 
                       download="portfolio-analysis.html" class="btn btn-light btn-sm">
                        <i class="bi bi-download me-1"></i>
                        Download
                    </a>
                </div>
            </div>
            
            {% if quantstats_html_content %}
            <!-- QuantStats HTML content injected directly - Full Width -->
            <div id="quantstats-content" class="quantstats-report-fullwidth">
                {{ quantstats_html_content|safe }}
            </div>
            {% else %}
            <div class="p-4 text-center bg-light rounded">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    QuantStats report not available. The report may still be generating.
                </div>
                <a href="{{ url_for('index') }}" class="btn btn-primary">
                    Run New Analysis
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Action Buttons -->
        <div class="row mt-4">
            <div class="col-md-6">
                <a href="/" class="btn btn-outline-primary btn-lg w-100">
                    <i class="bi bi-arrow-left me-2"></i>
                    Analyze Another Portfolio
                </a>
            </div>
            <div class="col-md-6">
                <button type="button" class="btn btn-primary btn-lg w-100" onclick="shareResults()">
                    <i class="bi bi-share me-2"></i>
                    Share Results
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>

    // Share functionality
    function shareResults() {
        if (navigator.share) {
            navigator.share({
                title: 'My Portfolio Analysis Results',
                text: 'Check out my Vietnam stock portfolio analysis results from Tearsheet',
                url: window.location.href
            });
        } else {
            // Fallback: copy URL to clipboard
            navigator.clipboard.writeText(window.location.href).then(function() {
                // Show toast notification
                const toast = `<div class="toast align-items-center text-white bg-success border-0 position-fixed top-0 end-0 m-3" role="alert" style="z-index: 9999;">
                    <div class="d-flex">
                        <div class="toast-body">
                            Link copied to clipboard!
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>`;
                document.body.insertAdjacentHTML('beforeend', toast);
                const toastEl = document.querySelector('.toast:last-child');
                const bsToast = new bootstrap.Toast(toastEl);
                bsToast.show();
                setTimeout(() => toastEl.remove(), 5000);
            });
        }
    }

    // Responsive iframe height adjustment
    function adjustIframeHeight() {
        const frame = document.getElementById('quantstats-frame');
        if (window.innerWidth < 768) {
            frame.style.height = '500px';
        } else {
            frame.style.height = '800px';
        }
    }

    window.addEventListener('resize', adjustIframeHeight);
    adjustIframeHeight();
</script>
{% endblock %}